<html>
    <body>
    <style>
        body {font-family: "Lucida Grande", "Geneva", "Helvetica", Arial, sans-serif}
        .selected {border-width: 2px; border-color: red}
    </style>
    <h4>IQE LED Command Staishe</h4>
    <hr>

    <p> Bilbo Knobbins: </p>
    <p> #2 <input data-path="/lx/modulation/Knobs/macro2" type="range" min="0" max="1.0" step="0.01"></p>
    <p> #3 <input data-path="/lx/modulation/Knobs/macro3" type="range" min="0" max="1.0" step="0.01"></p>
    
    <p> Form:
        <button data-path="/lx/mixer/channel/1/triggerPatternCycle">Next</button>
        <button data-path="/lx/mixer/channel/1/nextPattern" data-arg="1"
                data-select="/lx/mixer/channel/1/activePattern">A</button>
        <button data-path="/lx/mixer/channel/1/nextPattern" data-arg="2"
                data-select="/lx/mixer/channel/1/activePattern">B</button>
        <button data-path="/lx/mixer/channel/1/nextPattern" data-arg="3"
                data-select="/lx/mixer/channel/1/activePattern">C</button>
        <button data-path="/lx/mixer/channel/1/nextPattern" data-arg="7"
                data-select="/lx/mixer/channel/1/activePattern">D</button>
    </p>

    <p> Color:
        <button data-path="/lx/mixer/channel/2/triggerPatternCycle">Next</button>
        <button data-path="/lx/mixer/channel/2/nextPattern"
                data-select="/lx/mixer/channel/2/activePattern" data-arg="0">A</button>
        <button data-path="/lx/mixer/channel/2/nextPattern"
                data-select="/lx/mixer/channel/2/activePattern" data-arg="1">B</button>
    </p>
    
    <p>Tempo: <button data-path="/lx/tempo/tap" data-momentary-on="1" data-momentary-off="0">Tap</button>
    <input data-path="/lx/tempo/bpm" type="text" size="7" value="">
    <button data-path="/lx/tempo/nudgeDown" data-momentary-on="1" data-momentary-off="0"> &larr; </button>
    <button data-path="/lx/tempo/nudgeUp" data-momentary-on="1" data-momentary-off="0"> &rarr; </button>
    </p>

    <script src="/osc.min.js"></script>
    <script type="application/javascript">
        const osc = new OSC()
        const pathToElement = {}, selectPaths = {}
        document.querySelectorAll('[data-path]').forEach(el => pathToElement[el.getAttribute('data-path')] = el)
        document.querySelectorAll('[data-select]').forEach(el => (selectPaths[el.getAttribute('data-select')] = selectPaths[el.getAttribute('data-select')] || []).push(el))

        function receiveOsc(msg) {
            const el = pathToElement[msg.address]
            if (el) {
                el.value = msg.args[0]
            }
            const selections = selectPaths[msg.address]
            if (selections) {
                selections.forEach(el => el.classList.remove('selected'))
                selections.filter(el => el.getAttribute('data-arg') == msg.args[0])
                    .forEach(el => el.classList.add('selected'))
            }
        }

        document.querySelectorAll('[data-path][type="range"]').forEach(el => {
            const path = el.getAttribute('data-path')
            el.addEventListener('input', e => osc.send(new OSC.Message(path, parseFloat(e.target.value))))
        })

        document.querySelectorAll('button[data-path]').forEach(el => {
            const path = el.getAttribute('data-path')
            if (el.matches('[data-momentary-on][data-momentary-off]')) {
                const on = parseInt(el.getAttribute('data-momentary-on'))
                const off = parseInt(el.getAttribute('data-momentary-off'))
                el.addEventListener('mousedown', e => osc.send(new OSC.Message(path, on)))
                el.addEventListener('mouseup', e => osc.send(new OSC.Message(path, off)))
            }
            else {
                const arg = el.getAttribute('data-arg') ? parseFloat(el.getAttribute('data-arg')) : 1
                el.addEventListener('click', e => osc.send(new OSC.Message(path, arg)))
            }
        })

        document.querySelectorAll('[data-path][type="text"]').forEach(el => {
            const path = el.getAttribute('data-path')
            el.addEventListener('change', e => osc.send(new OSC.Message(path, parseFloat(e.target.value))))
        })

        osc.on('open', () => console.log('OSC Connected'))
        osc.on('*', msg => receiveOsc(msg))

        async function run() {
            const initialStateRes = await fetch('/state')
            const initialState = await initialStateRes.json()
            Object.values(initialState).forEach(msg => receiveOsc(msg))
            osc.open({ host: location.hostname, port: 8080 })
        }
        
        run()
        
    </script>
    </body>
</html>